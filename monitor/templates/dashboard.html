<!DOCTYPE html>
<html>
<head>
    <title>Cognitive Load Monitor</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { font-family: Arial; text-align: center; }
        video { transform: scaleX(-1); }
        .alert { color: red; font-weight: bold; }
    </style>
</head>
<body>

<h2>Cognitive Load Monitor</h2>

<video id="videoElement" width="480" height="360" autoplay></video>

<h3>Blink Count: <span id="blinkCount">0</span></h3>
<h3>Fatigue Score: <span id="fatigueScore">0</span></h3>
<h3 id="alertMessage" class="alert"></h3>

<script>

let blinkCount = 0;
let fatigueScore = 0;
let eyeClosedFrames = 0;
let lastBlinkTime = Date.now();

// Eye landmark indexes (MediaPipe)
const LEFT_EYE = [33, 160, 158, 133, 153, 144];
const RIGHT_EYE = [362, 385, 387, 263, 373, 380];

function distance(a, b) {
    return Math.sqrt(
        Math.pow(a.x - b.x, 2) +
        Math.pow(a.y - b.y, 2)
    );
}

function calculateEAR(landmarks, eye) {
    const A = distance(landmarks[eye[1]], landmarks[eye[5]]);
    const B = distance(landmarks[eye[2]], landmarks[eye[4]]);
    const C = distance(landmarks[eye[0]], landmarks[eye[3]]);
    return (A + B) / (2.0 * C);
}

const videoElement = document.getElementById('videoElement');

const faceMesh = new FaceMesh({
    locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }
});

faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});

faceMesh.onResults(results => {
    if (results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];

        const leftEAR = calculateEAR(landmarks, LEFT_EYE);
        const rightEAR = calculateEAR(landmarks, RIGHT_EYE);
        const avgEAR = (leftEAR + rightEAR) / 2.0;

        if (avgEAR < 0.20) {
            eyeClosedFrames++;
        } else {
            if (eyeClosedFrames > 2) {
                blinkCount++;
                document.getElementById("blinkCount").innerText = blinkCount;
            }
            eyeClosedFrames = 0;
        }

        // Fatigue logic
        if (blinkCount < 5) {
            fatigueScore = 6;
        } else {
            fatigueScore = 2;
        }

        document.getElementById("fatigueScore").innerText = fatigueScore;

        if (fatigueScore > 5) {
            document.getElementById("alertMessage").innerText =
                "âš  You seem tired. Please take a short break.";
        } else {
            document.getElementById("alertMessage").innerText = "";
        }

        sendDataToBackend(blinkCount, fatigueScore);
    }
});

const camera = new Camera(videoElement, {
    onFrame: async () => {
        await faceMesh.send({image: videoElement});
    },
    width: 480,
    height: 360
});
camera.start();

function sendDataToBackend(blink, fatigue) {
    fetch("/save-fatigue/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({
            blink_rate: blink,
            fatigue_score: fatigue
        })
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>

</body>
</html>